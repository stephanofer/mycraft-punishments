---
import { getPlayerName as getPlayerNameFromDB } from "../lib/queries";
import type { Ban, Kick, Mute, Warning } from "../lib/types";
import {
  cleanMinecraftText,
  formatDate,
  formatExpiry,
  getPunishmentStatus,
} from "../lib/utils";
import PlayerAvatar from "./PlayerAvatar.astro";
import PunishmentBadge from "./PunishmentBadge.astro";

interface Props {
  punishment: Ban | Mute | Kick | Warning;
  type: "ban" | "mute" | "kick" | "warning";
  showPlayer?: boolean;
  showStaff?: boolean;
}

const { punishment, type, showPlayer = true, showStaff = true } = Astro.props;

const status = getPunishmentStatus(punishment);
const isActive = status === "active";
const isPermanent = punishment.until === -1 || punishment.until === 0;

let playerName =
  (punishment as any).name || (punishment as any).playerName || null;
if (!playerName && punishment.uuid) {
  playerName = (await getPlayerNameFromDB(punishment.uuid)) || "Desconocido";
}

const typeColors = {
  ban: {
    border: "hover:border-red-500/50",
    glow: "group-hover:shadow-red-500/10",
  },
  mute: {
    border: "hover:border-yellow-500/50",
    glow: "group-hover:shadow-yellow-500/10",
  },
  kick: {
    border: "hover:border-blue-500/50",
    glow: "group-hover:shadow-blue-500/10",
  },
  warning: {
    border: "hover:border-orange-500/50",
    glow: "group-hover:shadow-orange-500/10",
  },
} as const;

const colors = typeColors[type];
const punishmentUrl = `/punishment/${type}/${punishment.id}`;
---

<a
  href={punishmentUrl}
  class:list={[
    "group block relative bg-zinc-900/50 backdrop-blur-sm border border-zinc-800 rounded-xl p-4 sm:p-5",
    "transition-all duration-300 ease-out cursor-pointer",
    colors.border,
    "hover:shadow-xl",
    colors.glow,
    "hover:-translate-x-2 hover:bg-zinc-900/80",
    "animate-fade-in",
  ]}
>
  <div
    class:list={[
      "absolute left-0 top-4 bottom-4 w-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300",
      type === "ban" && "bg-gradient-to-b from-red-500 to-red-600",
      type === "mute" && "bg-gradient-to-b from-yellow-500 to-yellow-600",
      type === "kick" && "bg-gradient-to-b from-blue-500 to-blue-600",
      type === "warning" && "bg-gradient-to-b from-orange-500 to-orange-600",
    ]}
  >
  </div>

  <div class="flex items-start gap-3 sm:gap-4">
    {
      showPlayer && (
        <div class="flex-shrink-0">
          <PlayerAvatar uuid={punishment.uuid} name={playerName} size="lg" />
        </div>
      )
    }

    <div class="flex-1 min-w-0">
      <div class="flex items-start justify-between gap-3 mb-2">
        <div class="flex-1 min-w-0">
          {
            showPlayer && (
              <span class="font-seven text-xl sm:text-2xl font-semibold text-white group-hover:text-purple-400 transition-colors truncate block">
                {playerName}
              </span>
            )
          }
          <div class="flex items-center gap-2 mt-1 flex-wrap">
            <PunishmentBadge type={type} />
            {
              isActive ? (
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-medium bg-green-500/20 text-green-400">
                  <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />
                  Activo
                </span>
              ) : (
                <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-zinc-800 text-zinc-400">
                  {status === "expired" ? "Expirado" : "Inactivo"}
                </span>
              )
            }
            {
              isPermanent && type !== "kick" && (
                <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-red-500/20 text-red-400">
                  Permanente
                </span>
              )
            }
          </div>
        </div>

        <div
          class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0"
        >
          <svg
            class="w-5 h-5 text-zinc-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </div>

      {
        punishment.reason && (
          <div class="mb-3">
            <p class="font-seven text-sm sm:text-base font-normal text-zinc-300 line-clamp-2">
              {cleanMinecraftText(punishment.reason)}
            </p>
          </div>
        )
      }

      <div
        class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs sm:text-sm text-zinc-500"
      >
        <span>{formatDate(punishment.time)}</span>

        {
          type !== "kick" && (
            <>
              <span>•</span>
              <span>{formatExpiry(punishment.until, punishment.active)}</span>
            </>
          )
        }

        {
          showStaff && punishment.banned_by_name && (
            <>
              <span>•</span>
              <span class="text-purple-400">
                por {punishment.banned_by_name}
              </span>
            </>
          )
        }
      </div>
    </div>
  </div>
</a>
