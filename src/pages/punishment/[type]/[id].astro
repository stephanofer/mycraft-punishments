---
import EmptyState from '../../../components/EmptyState.astro';
import Layout from '../../../layouts/Layout.astro';
import { getPlayerName, getPunishmentById } from '../../../lib/queries';
import { getSkinUrlSync, isConsoleUuid } from '../../../lib/skins';
import type { Ban, Mute, PunishmentType, Warning } from '../../../lib/types';
import {
  cleanMinecraftText,
  formatDate,
  formatExpiry,
  getBannerName,
  getPunishmentStatus,
  getPunishmentTypeLabel,
  isPermanent
} from '../../../lib/utils';

const { type, id } = Astro.params;

if (!type || !id) {
  return Astro.redirect('/');
}

const validTypes: PunishmentType[] = ['ban', 'mute', 'warning', 'kick'];
if (!validTypes.includes(type as PunishmentType)) {
  return Astro.redirect('/');
}

let punishment;
let playerName = 'Desconocido';
let bannerName = 'Desconocido';
let error = null;

try {
  punishment = await getPunishmentById(type as PunishmentType, parseInt(id));
  
  if (punishment) {
    playerName = await getPlayerName(punishment.uuid || '') || 'Desconocido';
    bannerName = getBannerName(punishment.banned_by_uuid, punishment.banned_by_name);
  }
} catch (e) {
  console.error('Error fetching punishment:', e);
  error = e;
}

if (!punishment) {
  return Astro.redirect('/');
}

const status = getPunishmentStatus(punishment);
const typeLabel = getPunishmentTypeLabel(type as PunishmentType);
const reason = cleanMinecraftText(punishment.reason) || 'Sin raz√≥n especificada';

const typeColors = {
  ban: { bg: 'from-red-950/50', border: 'border-red-500/20', text: 'text-red-400', icon: 'üö´' },
  mute: { bg: 'from-yellow-950/50', border: 'border-yellow-500/20', text: 'text-yellow-400', icon: 'üîá' },
  warning: { bg: 'from-orange-950/50', border: 'border-orange-500/20', text: 'text-orange-400', icon: '‚ö†Ô∏è' },
  kick: { bg: 'from-blue-950/50', border: 'border-blue-500/20', text: 'text-blue-400', icon: 'üë¢' },
};

const colors = typeColors[type as PunishmentType];

const statusStyles = {
  active: { bg: 'bg-red-500/15', border: 'border-red-500/30', text: 'text-red-400', label: 'Activo' },
  expired: { bg: 'bg-zinc-500/15', border: 'border-zinc-500/30', text: 'text-zinc-400', label: 'Expirado' },
  removed: { bg: 'bg-green-500/15', border: 'border-green-500/30', text: 'text-green-400', label: 'Removido' },
};

const statusStyle = statusStyles[status];

const hasRemovalInfo = 'removed_by_uuid' in punishment && punishment.removed_by_uuid;
const removedByName = hasRemovalInfo 
  ? (await getPlayerName((punishment as Ban | Mute | Warning).removed_by_uuid || '') || 
     cleanMinecraftText((punishment as Ban | Mute | Warning).removed_by_name) || 
     'Desconocido')
  : null;
---

<Layout title={`${typeLabel} #${id}`} description={`Detalles del ${typeLabel.toLowerCase()} de ${playerName}`}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <a 
      href="javascript:history.back()" 
      class="inline-flex items-center gap-2 text-zinc-400 hover:text-white transition-colors mb-6"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Volver
    </a>

    {error ? (
      <EmptyState type="error" message="Error al cargar los detalles." />
    ) : (
      <div class="space-y-6 animate-fade-in">
        <div class:list={[
          "relative rounded-3xl border overflow-hidden",
          `bg-gradient-to-br ${colors.bg} to-zinc-950`,
          colors.border
        ]}>
          <div class="relative p-6 sm:p-8 border-b border-zinc-800/50">
            <div class="flex flex-col sm:flex-row items-center gap-6">
              <a 
                href={`/player/${punishment.uuid?.replace(/-/g, '')}`}
                class="relative group"
              >
                <img
                  src={getSkinUrlSync(punishment.uuid || '')}
                  alt={playerName}
                  width="96"
                  height="96"
                  class="p-2 rounded-2xl pixelated bg-zinc-800 group-hover:scale-105 transition-transform"
                />
                <div class:list={[
                  "absolute -bottom-2 -right-2 w-8 h-8 rounded-lg flex items-center justify-center text-lg",
                  colors.text,
                  "bg-zinc-900 border",
                  colors.border
                ]}>
                  {colors.icon}
                </div>
              </a>

              <div class="flex-1 text-center sm:text-left">
                <div class="flex flex-wrap items-center justify-center sm:justify-start gap-3 mb-2">
                  <span class:list={["px-3 py-1 rounded-lg text-sm font-medium border", colors.bg, colors.border, colors.text]}>
                    {typeLabel} #{id}
                  </span>
                  <span class:list={["px-3 py-1 rounded-lg text-sm font-medium border", statusStyle.bg, statusStyle.border, statusStyle.text]}>
                    {statusStyle.label}
                  </span>
                </div>
                <h1 class="text-2xl sm:text-3xl font-clash font-bold text-white">
                  <a href={`/player/${punishment.uuid?.replace(/-/g, '')}`} class="font-seven hover:text-purple-400 transition-colors">
                    {playerName}
                  </a>
                </h1>
              </div>
            </div>
          </div>

          <div class="p-6 sm:p-8 grid gap-6 sm:grid-cols-2">
            <div class="sm:col-span-2">
              <label class="text-xs text-zinc-500 uppercase tracking-wide">Raz√≥n</label>
              <p class="font-seven mt-1 text-white text-lg whitespace-pre-wrap">{reason}</p>
            </div>

            <div>
              <label class="text-xs text-zinc-500 uppercase tracking-wide">Sancionado por</label>
              <a 
                href={`/staff/${punishment.banned_by_uuid?.replace(/-/g, '')}`}
                class="mt-2 flex items-center gap-3 group"
              >
                {isConsoleUuid(punishment.banned_by_uuid) ? (
                  <div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center text-lg">
                    üñ•Ô∏è
                  </div>
                ) : (
                  <img
                    src={getSkinUrlSync(punishment.banned_by_uuid || '')}
                    alt={bannerName}
                    width="40"
                    height="40"
                    class="p-2 rounded-lg pixelated bg-zinc-800"
                  />
                )}
                <span class="text-white font-medium group-hover:text-purple-400 transition-colors">
                  {bannerName}
                </span>
              </a>
            </div>

            <div>
              <label class="text-xs text-zinc-500 uppercase tracking-wide">Fecha</label>
              <p class="mt-2 text-white">{formatDate(punishment.time)}</p>
            </div>

            {type !== 'kick' && (
              <div>
                <label class="text-xs text-zinc-500 uppercase tracking-wide">Duraci√≥n</label>
                <p class:list={[
                  "mt-2 font-medium",
                  isPermanent(punishment.until) ? 'text-red-400' : 'text-white'
                ]}>
                  {formatExpiry(punishment.until, punishment.active)}
                </p>
              </div>
            )}

            {type !== 'kick' && punishment.until > 0 && (
              <div>
                <label class="text-xs text-zinc-500 uppercase tracking-wide">Expira</label>
                <p class="mt-2 text-white">{formatDate(punishment.until)}</p>
              </div>
            )}

            {punishment.server_origin && (
              <div>
                <label class="text-xs text-zinc-500 uppercase tracking-wide">Servidor de origen</label>
                <p class="mt-2 text-white">{punishment.server_origin}</p>
              </div>
            )}

            {punishment.server_scope && (
              <div>
                <label class="text-xs text-zinc-500 uppercase tracking-wide">Alcance</label>
                <p class="mt-2 text-white">
                  {punishment.server_scope === '*' ? 'Global (todos los servidores)' : punishment.server_scope}
                </p>
              </div>
            )}
          </div>

          {hasRemovalInfo && (
            <div class="p-6 sm:p-8 border-t border-zinc-800/50 bg-green-500/5">
              <h3 class="text-lg font-semibold text-green-400 mb-4 flex items-center gap-2">
                <span>‚úì</span>
                {type === 'ban' ? 'Desbaneado' : type === 'mute' ? 'Desmuteado' : 'Removido'}
              </h3>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label class="text-xs text-zinc-500 uppercase tracking-wide">Removido por</label>
                  <p class="mt-1 text-white">{removedByName}</p>
                </div>
                {(punishment as Ban | Mute | Warning).removed_by_date && (
                  <div>
                    <label class="text-xs text-zinc-500 uppercase tracking-wide">Fecha de remoci√≥n</label>
                    <p class="mt-1 text-white">
                      {formatDate(new Date((punishment as Ban | Mute | Warning).removed_by_date!).getTime())}
                    </p>
                  </div>
                )}
                {(punishment as Ban | Mute | Warning).removed_by_reason && (
                  <div class="sm:col-span-2">
                    <label class="text-xs text-zinc-500 uppercase tracking-wide">Raz√≥n de remoci√≥n</label>
                    <p class="mt-1 text-white">
                      {cleanMinecraftText((punishment as Ban | Mute | Warning).removed_by_reason)}
                    </p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

      </div>
    )}
  </div>
</Layout>

<style>
  .pixelated {
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
</style>
